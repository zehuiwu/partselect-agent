<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PartSelect Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Add Source Serif Pro font -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600&family=Playfair+Display:wght@500&display=swap" rel="stylesheet">
    <!-- Add marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom styles */
        :root {
            --partselect-orange: #E67E22;
            --partselect-teal: #4A7C7C;
            --header-height: 5rem; /* Define header height */
        }
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Source Serif Pro', serif;
            padding-top: var(--header-height); /* Add padding equal to header height */
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--header-height);
        }
        .logo-container {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
        }
        .logo-container img {
            height: 4rem; /* Increased from 3rem to 4rem */
            width: auto;
            object-fit: contain;
        }
        .contact-info {
            text-align: right;
            color: var(--partselect-teal);
            line-height: 1.4;
        }
        .phone-number {
            font-size: 1.5rem; /* Increased from 1.25rem */
            font-weight: 600;
            color: var(--partselect-orange);
            margin-bottom: 0.25rem;
        }
        .hours {
            font-size: 0.875rem;
            color: var(--partselect-teal);
            white-space: nowrap;
        }
        .response-time {
            font-size: 0.875rem;
            color: var(--partselect-teal);
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .logo-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--partselect-teal);
        }
        .years-badge {
            background-color: var(--partselect-orange);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .chat-container {
            background-color: transparent;
            min-height: calc(100vh - var(--header-height) - 100px); /* Adjust for header height */
            margin-bottom: 100px;
            width: 100%;
            max-width: 48rem; /* Match input container width */
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;
        }
        .message {
            transition: all 0.2s ease;
            margin-bottom: 1.5rem;
            font-size: 1.125rem;
            line-height: 1.6;
            width: 100%;
            max-width: 100%;
        }
        .user-message {
            background-color: #f1f3f5;
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            position: relative;
        }
        .user-tag {
            position: absolute;
            left: -3rem;
            top: 50%;
            transform: translateY(-50%);
            width: 2.5rem;
            height: 2.5rem;
            background-color: #e9ecef;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: #495057;
        }
        .assistant-message {
            background-color: transparent;
            padding: 0 1.25rem;
            width: 100%;
            max-width: 100%;
        }
        .input-container {
            background-color: transparent;
            padding: 1rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 20;
        }
        .input-wrapper {
            max-width: 48rem;
            margin: 0 auto;
            background-color: white; /* Ensure input has white background */
            border-radius: 1rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); /* Add subtle shadow */
        }
        #messageInput::placeholder {
            color: #6b7280;
            font-family: 'Source Serif Pro', serif;
        }
        .assistant-name {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            font-size: 2rem;
            color: #1f2937;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .assistant-name .name {
            font-family: 'Playfair Display', serif;
            font-weight: 500;
            background: linear-gradient(135deg, #1f2937 0%, #4B5563 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .tool-loading {
            display: none;
            width: 60px;
            height: 60px;
            position: relative;
            margin: 1rem 0;
        }
        
        .tool-loading.show {
            display: block;
        }
        
        .tool-icon {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: tool-spin 2s ease-in-out infinite;
        }
        
        @keyframes tool-spin {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
            100% { transform: rotate(360deg); }
        }

        #chatMessages {
            display: flex;
            flex-direction: column;
        }

        /* Markdown styles */
        .markdown-content {
            color: #1f2937;
        }
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            line-height: 1.25;
        }
        .markdown-content h1 { font-size: 1.875rem; }
        .markdown-content h2 { font-size: 1.5rem; }
        .markdown-content h3 { font-size: 1.25rem; }
        .markdown-content p {
            margin-bottom: 1em;
        }
        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        .markdown-content li {
            margin-bottom: 0.5em;
        }
        .markdown-content a {
            color: #2563eb;
            text-decoration: underline;
        }
        .markdown-content a:hover {
            color: #1d4ed8;
        }
        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-family: monospace;
        }
        .markdown-content pre {
            background-color: #f3f4f6;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            margin-left: 0;
            margin-bottom: 1em;
            color: #6b7280;
        }
        
        /* Loading message styles */
        .loading-message {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            color: #6b7280;
            font-style: italic;
        }
        
        .loading-dots {
            display: inline-block;
            position: relative;
            width: 24px;
            height: 24px;
            margin-left: 8px;
        }
        
        .loading-dots span {
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 8px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: loading-dots 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes loading-dots {
            0%, 80%, 100% { 
                transform: scale(0);
            } 
            40% { 
                transform: scale(1.0);
            }
        }

        /* Add regenerate button styles */
        .regenerate-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--partselect-teal);
            background-color: #f3f4f6;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 1rem;
            border: 1px solid #e5e7eb;
        }
        .regenerate-button:hover {
            background-color: #e5e7eb;
        }
        .regenerate-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .regenerate-button svg {
            width: 1rem;
            height: 1rem;
        }

        /* Add response navigation styles */
        .response-nav {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .response-nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .nav-arrows {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--partselect-teal);
            font-size: 0.875rem;
        }
        .nav-button {
            padding: 0.25rem;
            border-radius: 0.375rem;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s ease;
        }
        .nav-button:hover {
            opacity: 1;
            background-color: #f3f4f6;
        }
        .nav-button.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .nav-button svg {
            width: 1.25rem;
            height: 1.25rem;
        }
        .response-count {
            font-size: 0.875rem;
            color: #6b7280;
            min-width: 3rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Header with PartSelect logo -->
    <div class="header">
        <div class="logo-container">
            <a href="https://www.partselect.com" target="_blank" rel="noopener noreferrer">
                <img src="{{ url_for('static', filename='images/partselect-logo.png') }}?v=2" alt="PartSelect">
            </a>
        </div>
        <div class="contact-info">
            <div class="phone-number">1-888-741-7748</div>
            <div class="hours">Monday to Saturday<br>8am - 9pm EST</div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4">
        <div class="max-w-3xl mx-auto">
            <!-- Chat Interface -->
            <div class="chat-container pb-24">
                <div id="chatMessages" class="space-y-4 mb-4">
                    <!-- Introduction message will be added here via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Input Container -->
    <div class="input-container">
        <div class="input-wrapper">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 w-full p-4">
                <form id="chatForm" class="flex items-center gap-3">
                    <input type="text" id="messageInput" 
                           class="flex-1 text-lg border-0 bg-transparent focus:ring-0 focus:outline-none" 
                           placeholder="Ask about refrigerator or dishwasher parts...">
                    <button type="submit" class="text-gray-600 hover:text-gray-900 p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                        </svg>
                    </button>
                    <button type="button" id="resetButton" class="text-gray-600 hover:text-gray-900 p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </form>
                <div class="text-xs text-gray-500 mt-2 italic">Note: I may make mistakes. Please refer to product links for the most accurate information.</div>
            </div>
        </div>
    </div>

    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });

        // Function to scroll to bottom
        function scrollToBottom() {
            const scrollTarget = document.documentElement.scrollHeight;
            window.scrollTo({
                top: scrollTarget,
                behavior: 'smooth'
            });
        }

        // Add a map to store response history
        const responseHistory = new Map(); // query -> array of responses
        let currentResponseIndex = new Map(); // query -> current index

        // Function to create response container
        function createResponseContainer(query, startTime) {
            const chatMessages = document.getElementById('chatMessages');
            const responseContainer = document.createElement('div');
            responseContainer.className = 'message assistant-message';
            responseContainer.dataset.query = query;
            chatMessages.appendChild(responseContainer);

            const contentContainer = document.createElement('div');
            contentContainer.className = 'content-container';
            responseContainer.appendChild(contentContainer);

            const responseTimeContainer = document.createElement('div');
            responseTimeContainer.className = 'response-time';
            contentContainer.appendChild(responseTimeContainer);

            const markdownContainer = document.createElement('div');
            markdownContainer.className = 'markdown-content';
            contentContainer.appendChild(markdownContainer);

            // Add navigation container
            const navContainer = document.createElement('div');
            navContainer.className = 'response-nav';
            navContainer.style.display = 'none'; // Hide initially
            contentContainer.appendChild(navContainer);

            // Add loading elements
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'loading-message';
            loadingMessage.innerHTML = `
                <span id="loadingText">Checking the database</span>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            responseContainer.appendChild(loadingMessage);

            const toolLoading = document.createElement('div');
            toolLoading.className = 'tool-loading show';
            toolLoading.innerHTML = `
                <svg class="tool-icon" viewBox="0 0 24 24" fill="none" stroke="var(--partselect-teal)" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
            `;
            responseContainer.appendChild(toolLoading);

            return {
                responseContainer,
                contentContainer,
                responseTimeContainer,
                markdownContainer,
                navContainer,
                loadingMessage,
                toolLoading
            };
        }

        // Function to update response navigation
        function updateResponseNav(container, query, response) {
            const navContainer = container.querySelector('.response-nav');
            if (!responseHistory.has(query)) {
                responseHistory.set(query, []);
                currentResponseIndex.set(query, 0);
            }
            
            const responses = responseHistory.get(query);
            // Only add the response if it's a new regeneration
            if (!responses.includes(response)) {
                responses.push(response);
                currentResponseIndex.set(query, responses.length - 1);
            }
            const currentIndex = currentResponseIndex.get(query);
            
            // Update response time for the current response
            const responseTimeContainer = container.querySelector('.response-time');
            const responseTime = responses[currentIndex].responseTime;
            if (responseTime) {
                responseTimeContainer.textContent = `Response time: ${responseTime} seconds`;
            }
            
            // Only show regenerate button for the most recent message
            const allMessages = document.querySelectorAll('.assistant-message');
            const isLatestMessage = allMessages[allMessages.length - 1] === container;
            
            // Hide regenerate buttons for all previous messages
            allMessages.forEach((msg, index) => {
                if (index < allMessages.length - 1) {
                    const nav = msg.querySelector('.regenerate-container');
                    if (nav) nav.style.display = 'none';
                }
            });
            
            navContainer.style.display = 'flex';
            navContainer.innerHTML = `
                <div class="response-nav-controls">
                    ${responses.length > 1 ? `
                        <div class="nav-arrows">
                            <button class="nav-button ${currentIndex <= 0 ? 'disabled' : ''}" 
                                    onclick="navigateResponse('${query}', 'prev')" 
                                    ${currentIndex <= 0 ? 'disabled' : ''}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <span class="response-count">${currentIndex + 1}/${responses.length}</span>
                            <button class="nav-button ${currentIndex >= responses.length - 1 ? 'disabled' : ''}" 
                                    onclick="navigateResponse('${query}', 'next')"
                                    ${currentIndex >= responses.length - 1 ? 'disabled' : ''}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    ` : ''}
                    ${isLatestMessage ? `
                        <div class="regenerate-container">
                            <button class="regenerate-button" onclick="regenerateResponse('${query}')" ${currentIndex === responses.length - 1 ? '' : 'disabled'}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Regenerate response
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Function to navigate between responses
        function navigateResponse(query, direction) {
            const responses = responseHistory.get(query);
            let currentIndex = currentResponseIndex.get(query);
            
            if (direction === 'prev' && currentIndex > 0) {
                currentIndex = currentIndex - 1;
            } else if (direction === 'next' && currentIndex < responses.length - 1) {
                currentIndex = currentIndex + 1;
            }
            
            currentResponseIndex.set(query, currentIndex);
            
            // Find the current response container
            const responseContainer = document.querySelector(`.assistant-message[data-query="${query}"]`);
            const markdownContainer = responseContainer.querySelector('.markdown-content');
            
            // Update the response content
            markdownContainer.innerHTML = marked.parse(responses[currentIndex].content);
            
            // Update navigation controls
            updateResponseNav(responseContainer, query, responses[currentIndex]);
        }

        // Function to regenerate response
        async function regenerateResponse(query) {
            const responseContainer = document.querySelector(`.assistant-message[data-query="${query}"]`);
            const startTime = new Date();
            
            // Create new response container
            const {
                responseContainer: newContainer,
                contentContainer,
                responseTimeContainer,
                markdownContainer,
                navContainer,
                loadingMessage,
                toolLoading
            } = createResponseContainer(query, startTime);
            
            // Replace old response with new one
            responseContainer.replaceWith(newContainer);

            // Array of loading messages
            const loadingMessages = [
                "Regenerating response",
                "Searching our parts database",
                "Finding compatible parts",
                "Checking installation guides",
                "Looking up repair information"
            ];
            
            // Update loading message
            let messageIndex = 0;
            const loadingText = document.getElementById('loadingText');
            const updateLoadingMessage = () => {
                if (loadingText) {
                    loadingText.textContent = loadingMessages[messageIndex];
                    messageIndex = (messageIndex + 1) % loadingMessages.length;
                }
            };
            
            const messageInterval = setInterval(updateLoadingMessage, 3000);

            try {
                const response = await fetch('/api/regenerate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query }),
                });

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.error) {
                                    newContainer.className = 'bg-red-100 rounded-lg p-3 message';
                                    markdownContainer.innerHTML = `<p class="text-red-800">Error: ${data.error}</p>`;
                                    scrollToBottom();
                                } else if (data.response) {
                                    // Accumulate the response
                                    fullResponse += data.response;
                                    
                                    // Calculate response time
                                    const endTime = new Date();
                                    const responseTimeMs = endTime - startTime;
                                    const responseTimeSec = (responseTimeMs / 1000).toFixed(1);
                                    
                                    // Create response object with content and timing
                                    const responseObj = {
                                        content: fullResponse,
                                        responseTime: responseTimeSec
                                    };
                                    
                                    // Update UI
                                    responseTimeContainer.textContent = `Response time: ${responseTimeSec} seconds`;
                                    markdownContainer.innerHTML = marked.parse(fullResponse);
                                    updateResponseNav(newContainer, query, responseObj);
                                    
                                    scrollToBottom();
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }

                // Clear the interval for updating loading messages
                clearInterval(messageInterval);
                
                // Remove loading elements
                loadingMessage.remove();
                toolLoading.remove();
                
                scrollToBottom();

            } catch (error) {
                // Clear the interval for updating loading messages
                clearInterval(messageInterval);
                
                // Remove loading elements
                loadingMessage.remove();
                toolLoading.remove();
                
                // Show error
                newContainer.className = 'bg-red-100 rounded-lg p-3 message';
                markdownContainer.innerHTML = `<p class="text-red-800">Error: Failed to regenerate response</p>`;
                scrollToBottom();
            }
        }

        // Update the chat form handler
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.querySelector('button[type="submit"]');
            const query = messageInput.value.trim();
            if (!query) return;

            // Record start time
            const startTime = new Date();

            // Only disable send button while processing
            sendButton.disabled = true;
            sendButton.classList.add('opacity-50', 'cursor-not-allowed');

            // Add user message to chat
            const chatMessages = document.getElementById('chatMessages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.innerHTML = `
                <div class="user-tag">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="7" r="4"/>
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    </svg>
                </div>
                <p class="text-gray-900">${query}</p>
            `;
            chatMessages.appendChild(userMessageDiv);
            messageInput.value = '';
            
            // Hide regenerate buttons for all previous messages
            const allMessages = document.querySelectorAll('.assistant-message');
            allMessages.forEach(msg => {
                const nav = msg.querySelector('.regenerate-container');
                if (nav) nav.style.display = 'none';
            });
            
            // Force scroll to bottom after adding user message
            window.requestAnimationFrame(() => {
                scrollToBottom();
            });
            
            // Create response container
            const {
                responseContainer,
                contentContainer,
                responseTimeContainer,
                markdownContainer,
                navContainer,
                loadingMessage,
                toolLoading
            } = createResponseContainer(query, startTime);

            // Array of loading messages to cycle through
            const loadingMessages = [
                "Searching our parts database",
                "Finding compatible parts",
                "Checking installation guides",
                "Looking up repair information",
                "Preparing your response"
            ];
            
            // Function to update loading message
            let messageIndex = 0;
            const loadingText = document.getElementById('loadingText');
            const updateLoadingMessage = () => {
                if (loadingText) {
                    loadingText.textContent = loadingMessages[messageIndex];
                    messageIndex = (messageIndex + 1) % loadingMessages.length;
                }
            };
            
            // Update loading message every 3 seconds
            const messageInterval = setInterval(updateLoadingMessage, 3000);

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query }),
                });

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.error) {
                                    responseContainer.className = 'bg-red-100 rounded-lg p-3 message';
                                    markdownContainer.innerHTML = `<p class="text-red-800">Error: ${data.error}</p>`;
                                    scrollToBottom();
                                } else if (data.response) {
                                    // Accumulate the response
                                    fullResponse += data.response;
                                    
                                    // Calculate response time
                                    const endTime = new Date();
                                    const responseTimeMs = endTime - startTime;
                                    const responseTimeSec = (responseTimeMs / 1000).toFixed(1);
                                    
                                    // Create response object with content and timing
                                    const responseObj = {
                                        content: fullResponse,
                                        responseTime: responseTimeSec
                                    };
                                    
                                    // Update UI
                                    responseTimeContainer.textContent = `Response time: ${responseTimeSec} seconds`;
                                    markdownContainer.innerHTML = marked.parse(fullResponse);
                                    updateResponseNav(responseContainer, query, responseObj);
                                    
                                    scrollToBottom();
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }

                // Clear the interval for updating loading messages
                clearInterval(messageInterval);
                
                // Remove loading elements
                loadingMessage.remove();
                toolLoading.remove();
                
                scrollToBottom();

                // Re-enable send button after response
                sendButton.disabled = false;
                sendButton.classList.remove('opacity-50', 'cursor-not-allowed');

            } catch (error) {
                // Clear the interval for updating loading messages
                clearInterval(messageInterval);
                
                // Remove loading elements
                loadingMessage.remove();
                toolLoading.remove();
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-100 rounded-lg p-3 message';
                errorDiv.innerHTML = `<p class="text-red-800">Error: Failed to send message</p>`;
                chatMessages.appendChild(errorDiv);
                scrollToBottom();

                // Re-enable send button after error
                sendButton.disabled = false;
                sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
        
        // Add reset chat functionality
        document.getElementById('resetButton').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Clear the chat messages
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // Clear response history and current indices
                    responseHistory.clear();
                    currentResponseIndex.clear();
                    
                    // Add the introduction message
                    const introMessageDiv = document.createElement('div');
                    introMessageDiv.className = 'message assistant-message';
                    introMessageDiv.innerHTML = `
                        <div class="markdown-content">
                            <h2>👋 Welcome to PartSelect!</h2>
                            <p>I'm your appliance parts assistant, specializing in Refrigerator and Dishwasher parts. Our parts database was last updated on 04/06/2025.</p>
                            <p>I can help you:</p>
                            <ul>
                                <li>• Find the right parts based on symptoms or part descriptions</li>
                                <li>• Provide details on pricing, installation difficulty, and compatibility</li>
                                <li>• Guide you to our compatibility checker where you can verify if parts work with your model</li>
                                <li>• Share installation videos and repair guidance</li>
                                <li>• Assist with brand-specific replacement parts</li>
                            </ul>
                            <p>You can ask me questions like:</p>
                            <ul>
                                <li>• "How can I install part number PS11752778?"</li>
                                <li>• "Is this part compatible with my WDT780SAEM1 model?"</li>
                                <li>• "The ice maker on my Whirlpool fridge is not working. How can I fix it?"</li>
                            </ul>
                            <p>What refrigerator or dishwasher part information can I help you with today?</p>
                        </div>
                    `;
                    chatMessages.appendChild(introMessageDiv);
                    
                    // Add a message indicating the chat was reset
                    const resetMessageDiv = document.createElement('div');
                    resetMessageDiv.className = 'bg-gray-100 rounded-lg p-3 message';
                    resetMessageDiv.innerHTML = `<p class="text-gray-800">Chat history has been reset.</p>`;
                    chatMessages.appendChild(resetMessageDiv);
                    scrollToBottom();
                } else {
                    alert(data.error || 'Failed to reset chat history');
                }
            } catch (error) {
                console.error('Error resetting chat:', error);
                alert('Failed to reset chat history');
            }
        });

        // Add introduction message on page load
        window.addEventListener('DOMContentLoaded', (event) => {
            const chatMessages = document.getElementById('chatMessages');
            const introMessageDiv = document.createElement('div');
            introMessageDiv.className = 'message assistant-message';
            introMessageDiv.innerHTML = `
                <div class="markdown-content">
                    <h2>👋 Welcome to PartSelect!</h2>
                    <p>I'm your appliance parts assistant, specializing in Refrigerator and Dishwasher parts. Our parts database was last updated on 04/06/2025.</p>
                    <p>I can help you:</p>
                    <ul>
                        <li>• Find the right parts based on symptoms or part descriptions</li>
                        <li>• Provide details on pricing, installation difficulty, and compatibility</li>
                        <li>• Guide you to our compatibility checker where you can verify if parts work with your model</li>
                        <li>• Share installation videos and repair guidance</li>
                        <li>• Assist with brand-specific replacement parts</li>
                    </ul>
                    <p>You can ask me questions like:</p>
                    <ul>
                        <li>• "How can I install part number PS11752778?"</li>
                        <li>• "Is this part compatible with my WDT780SAEM1 model?"</li>
                        <li>• "The ice maker on my Whirlpool fridge is not working. How can I fix it?"</li>
                    </ul>
                    <p>What refrigerator or dishwasher part information can I help you with today?</p>
                </div>
            `;
            chatMessages.appendChild(introMessageDiv);
        });
    </script>
</body>
</html> 